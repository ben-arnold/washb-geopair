---
title: "Relative efficiency of geographic pair matching in the WASH Benefits trials"
subtitle: ""
author: "Ben Arnold ben.arnold@ucsf.edu"
date: "updated: `r Sys.time()`"
output: 
  html_document:
    theme: default
    highlight: haddock
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

Summary here: **TBD**

Relative efficacy based on non-parametric estimator from Imai, King, and Nall (2009)

Details of original citations and data sources here: **TBD**


# Preamble

```{r preamble}
library(here)
here()
#----------------------------
# source the config file
#----------------------------
source(here("R","washb-geopair-Config.R"))

```



# Bangladesh

## Data prep

```{r load bangladesh data}
#-------------------------------
# load the formatted analysis
# data created by
# washb-geopair-data-processing.R
#-------------------------------

# anthropometry data
danth <- read_rds(here("data","bangl_analysis_anthro.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0)) 
  

# child development data
dchdev <- read_rds(here("data","bangl_analysis_chdev.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0))

# diarrhea data
ddiar <- read_rds(here("data","bangl_analysis_diar.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0))

# giardia data
dpara <- read_rds(here("data","bangl_analysis_parasite.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0))

```

## Estimate ATE and relative efficacy

```{r estimate ATE using imai estimator}
#-------------------------------
# estimate_Imai_ATE
# convenience wrapper to run the 
# ATEcluster() function from the
# experiment package 
#
# and return a matched-pair level 
# data frame with key attributes. 
#
# It also calculates ATE 95% CIs
# based on the arithmetic mean 
# estimator from Imai et al. 2009
#
# It also estimates weighted
# and unweighted pair-wise
# outcome correlation, and 
# corresponding relative efficiency 
# of the matched pair design compared
# with an unmatched design
#
# Arguments, from environment::ATEcluster()
# @Y : outcome (vector)
# @Z : binary indicator of treatmetn (0/1)
# @grp : ID variable for clusters
# @match : ID variable for matched pairs
# @data : dataset that includes all these vars
#
# returns a list that includes:
# est       : ATE estimate, Imai 2009 estimator
# var       : Variance of ATE, Imai 2009 estimator
# est_min95 : lower bound of the 95% CI for ATE
# est_max95 : upper bound of the 95% CI for ATE
# corr_w : pair-wise outcome correlation, weighted
# corr_u : pair-wise outcome correlation, unweighted
# eff_w  : relative efficiencey of pair-matched design to unmatched design, weighted
# eff_u  : relative efficiencey of pair-matched design to unmatched design, unweighted
# dcl    : a data-frame of pair-level estimates, including:
#           Y1bar: mean in treatment clusters
#           Y0bar: mean in control clusters
#           diff: Y1bar-Y0bar
#           n1:  number of observations in treatment clusters (also used as weights)
#           n0:  number of observations in control clusters (also used as weights)
#           w:  pair-level weight (arithmetic mean)
#           w_dk:  pair-level weight (geometric mean, per Donner & Klar 1993)
#-------------------------------
library(experiment)

estimate_Imai_ATE <- function(Y,Z,grp,match,data) {
  
  # estimate ATE and cluster-level means
  estATE <- ATEcluster(Y=Y, Z=Z, grp=grp, match=match, data=data)
  
  # estimate 95% CIs based on the artimetic mean weighted variance
  # from Imai et al. 2009
  est_min95 <- estATE$est - 1.96*sqrt(estATE$var)
  est_max95 <- estATE$est + 1.96*sqrt(estATE$var)
  
  # estimate weighted and unweighted correlation between outcomes
  # see section 5.2 of Imai et al. 2009
  wY1bar <- estATE$Y1bar*estATE$w
  wY0bar <- estATE$Y0bar*estATE$w
  corr_w <- 2*cov(wY1bar,wY0bar) / ( var(wY1bar) + var(wY0bar) )
  corr_u <- cor(estATE$Y1bar,estATE$Y0bar)
  
  # estimate relative efficiency compared to an unmatched design
  # with weighted and unweighted correlation
  eff_w <- 1/(1-corr_w)
  eff_u <- 1/(1-corr_u)
  
  # combine cluster level measures in a data.frame()
  dcl <- data.frame(Y1bar=estATE$Y1bar,Y0bar=estATE$Y0bar,diff=estATE$diff,
                    n1=estATE$n1,n0=estATE$n0,w=estATE$w, w_dk=estATE$w.dk)
  
  return(
    list(est = estATE$est, var = estATE$var, est_min95=est_min95, est_max95=est_max95, corr_w=corr_w, corr_u=corr_u, eff_w= eff_w, eff_u=eff_u,  dcl=dcl)
  )
}

```

```{r estimate ATE and relative efficiency bangladesh}
#-------------------------------
# the estimate_Imai_ATE function
# does not allow for missing values
# in the outcome, so subset each
# dataset to non-missing values
# before each estimation
#-------------------------------

#-------------------------------
# LAZ
#-------------------------------
d <- danth %>% filter(!is.na(laz))
ate_laz <- estimate_Imai_ATE(Y=d$laz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# WAZ
#-------------------------------
d <- danth %>% filter(!is.na(waz))
ate_waz <- estimate_Imai_ATE(Y=d$waz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# WHZ
#-------------------------------
d <- danth %>% filter(!is.na(whz))
ate_whz <- estimate_Imai_ATE(Y=d$whz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# HCZ
#-------------------------------
d <- danth %>% filter(!is.na(hcz))
ate_hcz <- estimate_Imai_ATE(Y=d$hcz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# EASQ Communication
#-------------------------------
d <- dchdev %>% filter(!is.na(z_easq_com))
ate_easq_com <- estimate_Imai_ATE(Y=d$z_easq_com,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# EASQ Gross motor
#-------------------------------
d <- dchdev %>% filter(!is.na(z_easq_motor))
ate_easq_mot <- estimate_Imai_ATE(Y=d$z_easq_motor,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# EASQ Personal-social
#-------------------------------
d <- dchdev %>% filter(!is.na(z_easq_pers))
ate_easq_ps <- estimate_Imai_ATE(Y=d$z_easq_pers,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# CDI comprehension
#-------------------------------
d <- dchdev %>% filter(!is.na(z_cdi_comp))
ate_cdi_comp <- estimate_Imai_ATE(Y=d$z_cdi_comp,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# CDI expression
#-------------------------------
d <- dchdev %>% filter(!is.na(z_cdi_expr))
ate_cdi_expr <- estimate_Imai_ATE(Y=d$z_cdi_expr,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Diarrhea
#-------------------------------
d <- ddiar %>% filter(!is.na(diar7d))
ate_diar <- estimate_Imai_ATE(Y=d$diar7d,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Giardia
#-------------------------------
d <- dpara %>% filter(!is.na(giar))
ate_giar <- estimate_Imai_ATE(Y=d$giar,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Ascaris
#-------------------------------
d <- dpara %>% filter(!is.na(al))
ate_al <- estimate_Imai_ATE(Y=d$al,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Trichuris
#-------------------------------
d <- dpara %>% filter(!is.na(tt))
ate_tt <- estimate_Imai_ATE(Y=d$tt,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Hookworm
#-------------------------------
d <- dpara %>% filter(!is.na(hw))
ate_hw <- estimate_Imai_ATE(Y=d$hw,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

```


```{r summarize relative efficacy bangladesh}
#-------------------------------
# Summarize relative efficacy
#-------------------------------
ate_list <- list(ate_laz,ate_waz,ate_whz,ate_hcz,
                 ate_easq_com,ate_easq_mot,ate_easq_ps,ate_cdi_comp,ate_cdi_expr,
                 ate_diar,ate_giar,ate_al,ate_tt,ate_hw)
out_list <- c("length-for-age z",
                         "weight-for-age z",
                         "weight-for-height z",
                         "head circumference z",
                         "EASQ communication z",
                         "EASQ gross motor z",
                         "EASQ personal-social z",
                         "CDI comprehension z",
                         "CDI expression z",
                         "Diarrhea",
                         "Giardia sp.",
                         "Ascaris sp.",
                         "Trichuris sp.",
                         "Hookworm")

ate_res <- foreach(esti = 1:length(ate_list), .combine = rbind) %do% {
  res <- data.frame(est = ate_list[[esti]]$est, var = ate_list[[esti]]$var,
                    est_min95 = ate_list[[esti]]$est_min95, est_max95 = ate_list[[esti]]$est_max95,
                    corr_w = ate_list[[esti]]$corr_w, corr_u = ate_list[[esti]]$corr_u,
                    eff_w = ate_list[[esti]]$eff_w, eff_u = ate_list[[esti]]$eff_u)
  res
}
ate_res$outcome_lab <- out_list
ate_res <- ate_res %>%
  mutate(outcome_lab = factor(outcome_lab, levels = out_list),
         country = "Bangladesh") %>%
  dplyr::select(country,outcome_lab, everything())

```


# Kenya

## Data prep

```{r load Kenya data}
#-------------------------------
# load the formatted analysis
# data created by
# washb-geopair-data-processing.R
#
# in each dataset, exclude 
# the 9 matched blocks that do
# not have treatment contrasts
# for nutrition vs. control
#-------------------------------

# anthropometry data
dkanth <- read_rds(here("data","kenya_analysis_anthro.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0)) %>%
  filter(!block %in% c(11,13,23,33,40,65,72,84,85))


# diarrhea data
dkdiar <- read_rds(here("data","kenya_analysis_diar.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0)) %>%
  filter(!block %in% c(11,13,23,33,40,65,72,84,85))

# parasite data
dkpara <- read_rds(here("data","kenya_analysis_parasite.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0)) %>%
  filter(!block %in% c(11,13,23,33,40,65,72,84,85))

# child development data
dkchdev <- read_rds(here("data","kenya_analysis_chdev.rds")) %>%
  mutate(tr01 = ifelse(tr=="Nutrition",1,0)) %>%
  filter(!block %in% c(11,13,23,33,40,65,72,84,85)) 

```

## Estimate ATE and relative efficiency
```{r estimate ATE and relative efficiency kenya}
#-------------------------------
# the estimate_Imai_ATE function
# does not allow for missing values
# in the outcome, so subset each
# dataset to non-missing values
# before each estimation
#-------------------------------

#-------------------------------
# LAZ
#-------------------------------
d <- dkanth %>% filter(!is.na(laz)) 
k_ate_laz <- estimate_Imai_ATE(Y=d$laz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# WAZ
#-------------------------------
d <- dkanth %>% filter(!is.na(waz))
k_ate_waz <- estimate_Imai_ATE(Y=d$waz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# WHZ
#-------------------------------
d <- dkanth %>% filter(!is.na(whz))
k_ate_whz <- estimate_Imai_ATE(Y=d$whz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# HCZ
#-------------------------------
d <- dkanth %>% filter(!is.na(hcz))
k_ate_hcz <- estimate_Imai_ATE(Y=d$hcz,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# EASQ Communication
#-------------------------------
d <- dkchdev %>% filter(!is.na(z_easq_com))
k_ate_easq_com <- estimate_Imai_ATE(Y=d$z_easq_com,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# EASQ Gross motor
#-------------------------------
d <- dkchdev %>% filter(!is.na(z_easq_motor))
k_ate_easq_mot <- estimate_Imai_ATE(Y=d$z_easq_motor,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# EASQ Personal-social
#-------------------------------
d <- dkchdev %>% filter(!is.na(z_easq_pers))
k_ate_easq_ps <- estimate_Imai_ATE(Y=d$z_easq_pers,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)


#-------------------------------
# Diarrhea
#-------------------------------
d <- dkdiar %>% filter(!is.na(diar7d))
k_ate_diar <- estimate_Imai_ATE(Y=d$diar7d,Z=d$tr01,grp=d$clusterid,match=d$block,data=d)

#-------------------------------
# Giardia
#-------------------------------
d <- dkpara %>% filter(!is.na(giar))
k_ate_giar <- estimate_Imai_ATE(Y=d$giar,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# Ascaris
#-------------------------------
d <- dkpara %>% filter(!is.na(al))
k_ate_al <- estimate_Imai_ATE(Y=d$al,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# Trichuris
#-------------------------------
d <- dkpara %>% filter(!is.na(tt))
k_ate_tt <- estimate_Imai_ATE(Y=d$tt,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# Hookworm
#-------------------------------
d <- dkpara %>% filter(!is.na(hw))
k_ate_hw <- estimate_Imai_ATE(Y=d$hw,Z=d$tr01,grp=d$clusteridr2,match=d$block,data=d)

#-------------------------------
# detach experiment package
# because it uses MASS, which
# conflicts with dplyr::select()
#-------------------------------
detach("package:experiment", unload = TRUE)
detach("package:MASS", unload = TRUE)

```


```{r summarize relative efficiency kenya}
#-------------------------------
# Summarize relative efficiency
#-------------------------------
k_ate_list <- list(k_ate_laz,k_ate_waz,k_ate_whz,k_ate_hcz,
                 k_ate_easq_com,k_ate_easq_mot,k_ate_easq_ps,
                 k_ate_diar,k_ate_giar,k_ate_al,k_ate_tt,k_ate_hw)
k_out_list <- c("length-for-age z",
                         "weight-for-age z",
                         "weight-for-height z",
                         "head circumference z",
                         "EASQ communication z",
                         "EASQ gross motor z",
                         "EASQ personal-social z",
                         "Diarrhea",
                         "Giardia sp.",
                         "Ascaris sp.",
                         "Trichuris sp.",
                         "Hookworm")

k_ate_res <- foreach(esti = 1:length(k_ate_list), .combine = rbind) %do% {
  res <- data.frame(est = k_ate_list[[esti]]$est, var = k_ate_list[[esti]]$var,
                    est_min95 = k_ate_list[[esti]]$est_min95, est_max95 = k_ate_list[[esti]]$est_max95,
                    corr_w = k_ate_list[[esti]]$corr_w, corr_u = k_ate_list[[esti]]$corr_u,
                    eff_w = k_ate_list[[esti]]$eff_w, eff_u = k_ate_list[[esti]]$eff_u)
  res
}
k_ate_res$outcome_lab <- k_out_list
k_ate_res <- k_ate_res %>%
  mutate(outcome_lab = factor(outcome_lab, levels = out_list),
         country = "Kenya") %>%
  dplyr::select(country,outcome_lab, everything())

```

# Save pair-level summary dataset

Save a dataset that includes pair-level means and treatment effects. These estimates will be used in later analysis and plotting

```{r assemble pair level data}
#-------------------------------
# get the pair-level estimates
# Bangladesh
#-------------------------------
dcl_b <- foreach(i = 1:length(ate_list), .combine = rbind) %do% {
  dcli <- ate_list[[i]]$dcl
  dcli$block <- row.names(dcli)
  dcli$outcome_lab <- out_list[i]
  dcli$country = "Bangladesh"
  dcli
}
#-------------------------------
# get the pair-level estimates
# Kenya
#-------------------------------
dcl_k <- foreach(i = 1:length(k_ate_list), .combine = rbind) %do% {
  dcli <- k_ate_list[[i]]$dcl
  dcli$block <- row.names(dcli)
  dcli$outcome_lab <- k_out_list[i]
  dcli$country = "Kenya"
  dcli
}

#-------------------------------
# stack the data and convert
# some of the variables to 
# factors
#-------------------------------
dcl <- bind_rows(dcl_b,dcl_k) %>%
  mutate(outcome_lab=factor(outcome_lab, levels= out_list),
         country = factor(country)) %>%
  select(country,outcome_lab,block,everything()) %>%
  arrange(country,outcome_lab,block)

write_rds(dcl, path = here("data","washb_pair_level_summary_estimates.rds"))
write_csv(dcl, path = here("data","washb_pair_level_summary_estimates.csv"))


```

# Relative Efficiency table

```{r summary relative efficacy table}
options(knitr.kable.NA = "‡")

sumtab <- ate_res %>%
  select(outcome_lab, bcorr_w = corr_w, beff_w = eff_w) %>%
  left_join(k_ate_res, by = "outcome_lab") %>%
  select(outcome_lab, bcorr_w, corr_w, beff_w, eff_w)


knitr::kable(sumtab,
             digits = c(0,2,2,1,1),
             align = c("lcccc"),
             col.names = c("Outcome","Bangladesh","Kenya","Bangladesh","Kenya"),
             caption = "Summary of pair-wise outcome correlation and relative efficacy of geographic pair-matching") %>%
  kable_styling(bootstrap_options = "striped") %>%
  pack_rows("Child growth",1,4) %>%
  pack_rows("Child development",5,9) %>%
  pack_rows("Infectious disease",10,14) %>%
  add_header_above(c(" " = 1, "Pair-wise correlation*" = 2, "Relative Efficiency†" = 2)) %>%
  footnote(symbol = c("Correlation between geographically paired, cluster-level means weighted by cluster sizes.",
                      "Relative efficiency of geographic pair-matching compared to an unmatched design, defined as 1/(1-r), where r is the correlation between paired outcomes. A relative efficiency of 2 means that a pair-matched study with 30 clusters per group has the same power as an unmatched study with 60 clusters per group.","Communicative Development Inventory (CDI) measures were not collected in the Kenya trial."))

```


# Relative Efficiency Figure

```{r plot relative efficiency, warning = FALSE}
# pivot the summary table longer to plot
dreffplot <- ate_res %>%
  select(country, outcome_lab, corr_u, eff_u, corr_w, eff_w) %>%
  bind_rows(k_ate_res %>% select(country, outcome_lab, corr_u, eff_u,  corr_w, eff_w))
# group outcomes for plot aesthetics
dreffplot$outcome_group = c(rep("Child growth",4),rep("Child development",5),rep("Infectious disease",5) , rep("Child growth",4),rep("Child development",3),rep("Infectious disease",5))
# make shorter outcome labels
dreffplot$outcome_lab2 = c( c("LAZ","WAZ","WHZ","HCZ","EASQ Communication","EASQ Gross motor","EASQ Personal-social","CDI Comprehension","CDI Expression","Diarrhea","Giardia sp.","Ascaris sp.","Trichuris sp.","Hookworm"), c("LAZ","WAZ","WHZ","HCZ","EASQ Communication","EASQ Gross motor","EASQ Personal-social","Diarrhea","Giardia sp.","Ascaris sp.","Trichuris sp.","Hookworm"))

dreffplot2 <- dreffplot %>%
  mutate(outcome_group = factor(outcome_group),
         country = factor(country)) %>%
  # tedious x and y nudge coordinates for labels to optimize display
  mutate(lab_xnudge = case_when(
           outcome_lab2 == "LAZ" & country == "Bangladesh" ~ 0.015,
           outcome_lab2 == "HCZ" & country == "Bangladesh" ~ 0.015,
           outcome_lab2 == "Diarrhea" & country == "Bangladesh" ~ 0.015,
           outcome_lab2 == "WHZ" & country == "Kenya" ~ 0.015,
           outcome_lab2 %in% c("EASQ Communication","EASQ Personal-social","CDI Expression") & country == "Bangladesh" ~ 0.015,
           TRUE ~ as.numeric(-0.015)
         ),
         lab_ynudge = case_when(
           outcome_lab2 == "Hookworm" & country == "Kenya" ~ 0.02,
           outcome_lab2 == "Trichuris sp." & country == "Kenya" ~ 0.02,
           outcome_lab2 == "WHZ" & country == "Kenya" ~ -0.02,
           outcome_lab2 == "EASQ Gross motor" & country == "Bangladesh" ~ 0.01,
           outcome_lab2 == "EASQ Personal-social" & country == "Bangladesh" ~ -0.02,
           outcome_lab2 == "EASQ Personal-social" & country == "Kenya" ~ 0.02,
           outcome_lab2 == "CDI Comprehension" & country == "Bangladesh" ~ 0.02,
           outcome_lab2 == "CDI Expression" & country == "Bangladesh" ~ -0.04,
           TRUE ~ as.numeric(0)
         ),
         lab_hjust = ifelse(lab_xnudge < 0 , 1, 0)
         )


# data frame for function
d_reff <- data.frame(rho = seq(0,0.8,by=0.01)) %>%
  mutate(reff = 1/(1-rho))

# make plot
pcols <- c("#D9B86A", "#9B9F7C", "#5986B0")
plot_reff <- ggplot(data=dreffplot2, aes(x = corr_w, y = eff_w)) +
  # facet over country
  facet_grid(~country) +
  # add function line
  geom_line(data=d_reff,aes(x=rho,y=reff),alpha = 0.4, linetype = "dashed", show.legend = FALSE) +
  # plot results
  # this offset is very idiosyncratic to optimize display -- fragile code!
  geom_text(aes(label = outcome_lab2, color = outcome_group), 
            hjust = dreffplot2$lab_hjust, 
            nudge_x = dreffplot2$lab_xnudge,
            nudge_y = dreffplot2$lab_ynudge,
            size = 2.5, show.legend = FALSE) +
  geom_point(aes(color = outcome_group), size = 2.2, alpha=1) + 
  geom_point(pch=21,bg=NA, size=2.2, show.legend = TRUE) +
  # refine aesthetics
  scale_color_manual(values = pcols, guide=guide_legend(title="Outcome group:")) +
  # scale_color_brewer(palette = "Dark2", guide=guide_legend(title="Outcome group:")) +

  # scale_color_viridis_d(begin = 0, end = 0.6, direction = -1, option = "D",  guide=guide_legend(title="Outcome group:")) +
  scale_y_continuous(breaks=seq(1,3.2,by=0.2))+
  scale_x_continuous(breaks=seq(0,0.7,by=0.1)) +
  coord_cartesian(ylim=c(1,3.2),xlim = c(0,0.7)) +
  labs(x=expression(paste("Correlation between paired outcomes, (",italic(r),")")),y=expression(paste("Relative efficiency of geographic pair-matching, (1-",italic(r),")")^-1)) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
plot_reff

ggsave(filename = here("output","washb-geopair-relative-efficiency.png"),plot_reff,device = "png", height=5,width=7)

```

# Correlation figure

Compare weighted versus unweighted correlation

```{r plot correlation}
pcols <- c("#D9B86A", "#9B9F7C", "#5986B0")
plot_corr <- ggplot(data = dreffplot, aes(x = corr_w, y = corr_u, color = outcome_group)) +
  facet_grid(~country) +
  geom_abline(intercept = 0, slope = 1, color="gray40") +
  geom_point(size=2.5, alpha=0.9) +
  geom_point(pch=21, bg=NA, size=2.5, show.legend = TRUE) +
  geom_text(data = dreffplot %>% filter(corr_w - corr_u >0.2), 
            aes(label = outcome_lab2, color = outcome_group),
            size = 2.5, hjust=1, nudge_x = -0.02,show.legend = FALSE) +
  scale_color_manual(values = pcols, guide=guide_legend(title="Outcome group:")) +
  scale_fill_manual(values = pcols) +
  # scale_color_brewer(palette = "Dark2", guide=guide_legend(title="Outcome group:")) +
  scale_x_continuous(breaks=seq(0,0.7,by=0.1))+
  scale_y_continuous(breaks=seq(0,0.7,by=0.1))+
  labs(x = "Weighted correlation", y = "Unweighted correlation") +
  coord_cartesian(xlim=c(0,0.7),ylim = c(0,0.7)) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )


plot_corr

ggsave(filename = here("output","washb-geopair-correlation-weight-v-unweight.png"),plot_corr,device = "png", height=4.5,width=7)
  
```

# Session Info
```{r session info}
sessionInfo()
```


